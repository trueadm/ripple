import { flushSync, track } from 'ripple';

describe('switch statements', () => {
	it('renders simple switch with literal cases', () => {
		component App() {
			let value = track('b');

			<button onClick={() => (@value = 'c')}>{'Change to C'}</button>
			<button onClick={() => (@value = 'a')}>{'Change to A'}</button>

			switch (@value) {
				case 'a':
					<div>{'Case A'}</div>
					break;
				case 'b':
					<div>{'Case B'}</div>
					break;
				case 'c':
					<div>{'Case C'}</div>
					break;
				default:
					<div>{'Default Case'}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Case B');

		container.querySelectorAll('button')[0].click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case C');
		container.querySelectorAll('button')[1].click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case A');
	});

	it('renders switch with reactive discriminant', () => {
		component App() {
			let count = track(1);

			<button onClick={() => @count++}>{'Increment'}</button>

			switch (@count) {
				case 1:
					<div>{'Count is 1'}</div>
					break;
				case 2:
					<div>{'Count is 2'}</div>
					break;
				default:
					<div>{'Count is other'}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Count is 1');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Count is 2');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Count is other');
	});

	it('renders switch with default clause only', () => {
		component App() {
			let value = track('x');

			<button onClick={() => (@value = 'y')}>{'Change Value'}</button>

			switch (@value) {
				default:
					<div>{'Default for ' + @value}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Default for x');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Default for y');
	});

	it('renders switch using empty case fallthrough', () => {
		component App() {
			let value = track('a');

			<button onClick={() => (@value = 'b')}>{'Change to B'}</button>
			<button onClick={() => (@value = 'c')}>{'Change to C'}</button>

			switch (@value) {
				case 'a':
					<div>{'Case A'}</div>
					break;
				case 'b':
				case 'c':
					<div>{'Case B or C'}</div>
					break;
				default:
					<div>{'Default Case'}</div>
			}
		}

		render(App);
		const [buttonB, buttonC] = container.querySelectorAll('button');

		expect(container.querySelector('div').textContent).toContain('Case A');

		buttonB.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case B or C');

		buttonC.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case B or C');

		container.querySelector('div').textContent = 'DOM check';
		buttonB.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('DOM check');
	});

	it('renders switch with template content and reacts to tracked changes', () => {
		component App() {
			let status = track('active');
			let message = track('');

			<button onClick={() => (@status = 'pending')}>{'Pending'}</button>
			<button onClick={() => (@status = 'completed')}>{'Completed'}</button>
			<button onClick={() => (@status = 'error')}>{'Error'}</button>

			switch (@status) {
				case 'active':
					@message = 'Currently active.';
					<div>{'Status: ' + @message}</div>
					break;
				case 'pending':
					@message = 'Waiting for completion.';
					<div>{'Status: ' + @message}</div>
					break;
				case 'completed':
					@message = 'Task finished!';
					<div class="success">{'Status: ' + @message}</div>
					break;
				default:
					@message = 'An error occurred.';
					<div class="error">{'Status: ' + @message}</div>
			}
		}

		render(App);
		const [buttonPending, buttonCompleted, buttonError] = container.querySelectorAll('button');
		expect(container.querySelector('div').textContent).toBe('Status: Currently active.');

		buttonPending.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: Waiting for completion.');

		buttonCompleted.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: Task finished!');
		expect(container.querySelector('.success')).toBeTruthy();

		buttonError.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: An error occurred.');
		expect(container.querySelector('.error')).toBeTruthy();
	});

	it(
		'renders switch with multiple non-empty fallthrough cases and reacts to tracked changes without recreating DOM unnecessarily',
		() => {
			component App() {
				let status = track(0);
				<div>
					switch (@status) {
						case -1:
						case 0:
							<p>{' Idle'}</p>
						case 1:
							<p>{' Loading'}</p>
						case 2:
							<p>{' Success'}</p>
							break;
						default:
							<p>{' Unknown status'}</p>
							<p>{' Unknown 2'}</p>
						case 3:
							<p>{' Error'}</p>
							<p>{' Error 2'}</p>
							<p>{' Error 3'}</p>
							break;
					}
				</div>
				<button
					onClick={() => {
						@status = (@status + 1) % 5;
					}}
				>
					{'Next Status'}
				</button>
			}

			render(App);
			const button = container.querySelector('button');

			expect(container.querySelector('div').textContent).toBe(' Idle Loading Success');

			button.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Loading Success');

			button.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Success');

			button.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Error Error 2 Error 3');

			button.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(
				' Unknown status Unknown 2 Error Error 2 Error 3',
			);

			button.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Idle Loading Success');
		},
	);

	it(
		'renders a fallthrough default in the middle of switch cases and reacts to changes without recreating DOM unnecessarily',
		() => {
			component App() {
				let value = track('x');

				<button onClick={() => (@value = 'a')}>{'Set A'}</button>
				<button onClick={() => (@value = 'b')}>{'Set B'}</button>
				<button onClick={() => (@value = 'c')}>{'Set C'}</button>
				<button onClick={() => (@value = 'x')}>{'Set X'}</button>

				<div>
					switch (@value) {
						case 'a':
							<div>{' Case A'}</div>
							break;
						// NOTE: This should be the default in the middle of the cases
						// However, jsdom (and other node-based dom libs) has a bug
						// that breaks out of the switch even if the default doesn't have a break
						// The browser works correctly.
						// So, we're just using a defined case in the middle to simulate default.
						case 'x':
							<div>{' Default Case for ' + @value}</div>
						case 'b':
							<div>{' Case B'}</div>
							break;
						case 'c':
							<div>{' Case C'}</div>
					}
				</div>
			}

			render(App);
			const [buttonA, buttonB, buttonC, buttonX] = container.querySelectorAll('button');

			expect(container.querySelector('div').textContent).toBe(' Default Case for x Case B');
			expect(container.querySelector('div').querySelectorAll('div').length).toBe(2);

			buttonA.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Case A');
			expect(container.querySelector('div').querySelectorAll('div').length).toBe(1);

			buttonC.click();
			flushSync();

			expect(container.querySelector('div').textContent).toBe(' Case C');
			expect(container.querySelector('div').querySelectorAll('div').length).toBe(1);

			buttonB.click();
			flushSync();

			const bDiv = container.querySelector('div').querySelectorAll('div')[0];
			expect(bDiv.textContent).toBe(' Case B');
			bDiv.id = 'b';

			buttonX.click();
			flushSync();

			// order should be correct with the previously rendered B element
			expect(container.querySelector('div').textContent).toBe(' Default Case for x Case B');
			expect(container.querySelector('div').querySelectorAll('div').length).toBe(2);
			// the previously rendered div should be preserved
			expect(container.querySelector('div').querySelectorAll('div')[1].id).toBe('b');
		},
	);
});
