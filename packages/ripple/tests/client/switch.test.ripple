import { flushSync, track } from 'ripple';

describe('switch statements', () => {
	it('renders simple switch with literal cases', () => {
		component App() {
			let value = track('b');

			<button onClick={() => (@value = 'c')}>{'Change to C'}</button>
			<button onClick={() => (@value = 'a')}>{'Change to A'}</button>

			switch (@value) {
				case 'a':
					<div>{'Case A'}</div>
					break;
				case 'b':
					<div>{'Case B'}</div>
					break;
				case 'c':
					<div>{'Case C'}</div>
					break;
				default:
					<div>{'Default Case'}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Case B');

		container.querySelectorAll('button')[0].click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case C');
		container.querySelectorAll('button')[1].click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case A');
	});

	it('renders switch with reactive discriminant', () => {
		component App() {
			let count = track(1);

			<button onClick={() => @count++}>{'Increment'}</button>

			switch (@count) {
				case 1:
					<div>{'Count is 1'}</div>
					break;
				case 2:
					<div>{'Count is 2'}</div>
					break;
				default:
					<div>{'Count is other'}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Count is 1');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Count is 2');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Count is other');
	});

	it('renders switch with default clause only', () => {
		component App() {
			let value = track('x');

			<button onClick={() => (@value = 'y')}>{'Change Value'}</button>

			switch (@value) {
				default:
					<div>{'Default for ' + @value}</div>
			}
		}

		render(App);
		expect(container.querySelector('div').textContent).toBe('Default for x');

		container.querySelector('button').click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Default for y');
	});

	it('renders switch using fallthrough without recreating DOM unnecessarily', () => {
		component App() {
			let value = track('a');

			<button onClick={() => (@value = 'b')}>{'Change to B'}</button>
			<button onClick={() => (@value = 'c')}>{'Change to C'}</button>

			switch (@value) {
				case 'a':
					<div>{'Case A'}</div>
					break;
				case 'b':
				case 'c':
					<div>{'Case B or C'}</div>
					break;
				default:
					<div>{'Default Case'}</div>
			}
		}

		render(App);
		const [buttonB, buttonC] = container.querySelectorAll('button');

		expect(container.querySelector('div').textContent).toContain('Case A');

		buttonB.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case B or C');

		buttonC.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Case B or C');

		container.querySelector('div').textContent = 'DOM check';
		buttonB.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('DOM check');
	});

	it('renders switch with template content and JS logic', () => {
		component App() {
			let status = track('active');
			let message = track('');

			<button onClick={() => (@status = 'pending')}>{'Pending'}</button>
			<button onClick={() => (@status = 'completed')}>{'Completed'}</button>
			<button onClick={() => (@status = 'error')}>{'Error'}</button>

			switch (@status) {
				case 'active':
					@message = 'Currently active.';
					<div>{'Status: ' + @message}</div>
					break;
				case 'pending':
					@message = 'Waiting for completion.';
					<div>{'Status: ' + @message}</div>
					break;
				case 'completed':
					@message = 'Task finished!';
					<div class="success">{'Status: ' + @message}</div>
					break;
				default:
					@message = 'An error occurred.';
					<div class="error">{'Status: ' + @message}</div>
			}
		}

		render(App);
		const [buttonPending, buttonCompleted, buttonError] = container.querySelectorAll('button');
		expect(container.querySelector('div').textContent).toBe('Status: Currently active.');

		buttonPending.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: Waiting for completion.');

		buttonCompleted.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: Task finished!');
		expect(container.querySelector('.success')).toBeTruthy();

		buttonError.click();
		flushSync();

		expect(container.querySelector('div').textContent).toBe('Status: An error occurred.');
		expect(container.querySelector('.error')).toBeTruthy();
	});
});
